<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/css/cropper/cropper.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="/js/backbone.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.syphon/0.4.1/backbone.syphon.min.js"></script>
    <script src="https://www.parsecdn.com/js/parse-1.2.8.min.js"></script>
    <script src="/js/lib/cropper.min.js"></script>
    <script src="/js/lib/bootstrap.file-input.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <script>
        //APP_ID, JS_KEY
        Parse.initialize("iwGsOVQf75GczDN5rbPWBnpVjRnihfldbFx7wpYq", "gTUfi1ECtDr29soNjEAdXmCUcwrUGKvw5NVMGHTw");
        _.templateSettings = {
            evaluate:    /\{\{(.+?)\}\}/g,
            interpolate: /\{\{=(.+?)\}\}/g,
            escape:      /\{\{-(.+?)\}\}/g
        };

    </script>
    <script src="/js/utils/utils.js"></script>
    <!--
    <script type="text/javascript" src="/js/main.js"></script>
    -->
    <link rel="stylesheet" href="/css/main.css">

    <title>法餐地图</title>

</head>
<body role="document">

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">法餐地图-后台</a>
        </div>
        <div class="collapse navbar-collapse">
            <% if(Parse.User.current()){%>
            <ul class="nav navbar-nav">
                <li><a href="/a/restos">饭馆列表</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">

                <li>
                    <form class="navbar-form" method="post" action="/logout">
                        <div clss="form-group">
                            <button type="submit"><span class="glyphicon glyphicon-off"></span> </button>
                        </div>
                    </form>
                </li>

            </ul>
            <% } %>
        </div><!--/.nav-collapse -->
    </div>
</div>

<div class="container" role="main">

    <input onchange="javascript:submitPhoto();" title="Choisir une image" type="file" id="imageUploader"  accept="image/jpeg, image/png">

    <div id="originalImage" style="max-width: 600px;">
        <img id="imageContainer" class="cropper">
    </div>

    <div id="resultImage" style="display: none; ">
        
        <img id="thumbnailPhoto" style="min-width: 180px;"  data-toggle="modal" data-target="#normalImageModel"/>
    </div>

    <button onclick="javascript:submitCroppedPhoto();">submit cropped image</button>

    <div class="modal fade" id="normalImageModel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">Modal title</h4>
                </div>
                <div class="modal-body">
                    <p><img id="croppedPhotoResult" /> </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

</div><!-- /.container -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<script type="text/javascript">

    function dataURItoBlob(dataURI) {
        var byteString = atob(dataURI.split(',')[1]);
        var ab = new ArrayBuffer(byteString.length);
        var ia = new Uint8Array(ab);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: 'image/jpeg' });
    }


    $('input[type=file]').bootstrapFileInput();

    var croppedResult = null;
    var originalPhoto = null;
    function submitPhoto(){

        if ($("#imageUploader")[0].files.length > 0) {

            var file = $("#imageUploader")[0].files[0];

            // Create an image
            var img = document.createElement("img");
            // Create a file reader
            var reader = new FileReader();
            // Set the image once loaded into file reader
            reader.onload = function(e)
            {
                img.src = e.target.result;

                var canvas = document.createElement("canvas");
                //var canvas = $("<canvas>", {"id":"testing"})[0];
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);

                var MAX_WIDTH = 1024;
                var MAX_HEIGHT = 768;
                var width = img.width;
                var height = img.height;

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);

                var dataurl = canvas.toDataURL("image/jpeg");

                var name = "image.jpg";
                var parseFile = new Parse.File(name, {base64: dataurl.substring(23)});


                parseFile.save().then(function() {

                    originalPhoto=parseFile;
                    $("#imageContainer").attr("src",parseFile.url());
                    $(".cropper").cropper({
                        aspectRatio: 1.333,
                        done: function(data) {
                            croppedResult = data;
                        }
                    });
                });

            }
            // Load files into file reader


            reader.readAsDataURL(file);


        } else {
            alert("Please select a file");
        }
    }
    function submitCroppedPhoto(){


        var photo = new Parse.Object("Photo");
        photo.set("originalPhoto",originalPhoto);
        photo.set("croppedx",croppedResult.x);
        photo.set("croppedy",croppedResult.y);
        photo.set("croppedWidth",croppedResult.width);
        photo.set("croppedHeight",croppedResult.height);
        photo.save().then(
                function(photo){
                    console.log(photo);
                    $("#originalImage").hide();
                    $("#resultImage").show();
                    $("#thumbnailPhoto").attr("src",photo.get("thumbnailPhoto").url());
                    $("#croppedPhotoResult").attr("src",photo.get("normalPhoto").url());
                }

        )
    }

    function showModel(){

    }

</script>
</body>
</html>

<!--
Redirect to resaurant
<script type="text/javascript">

    window.location = "/a/restos";

</script>

-->